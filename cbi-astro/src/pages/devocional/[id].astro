---
// src/pages/devocional/[id].astro
import Layout from "../../layouts/Layout.astro"
import OpenBookIcon from "../../components/icons/OpenBookIcon.astro"
import {
  ArrowLeft,
  CalendarDays,
  ChevronDown,
  ClipboardList,
  Folder,
} from "lucide-react"
import { getDevotionalById, getDevotionals } from "../../helpers/notion"

type Devotional = {
  id: string
  title: string
  date: string
  verse?: string
  content?: string
  assets?: string | string[]
}

type Step = {
  title: string
  description: string
  bullets?: string[]
}

// Disable prerendering since we're fetching dynamic content from Notion
export const prerender = false

const { id } = Astro.params

// Get the devotional data and a small list of recent devotionals
const [devotional, devotionals] = await Promise.all([
  getDevotionalById(id),
  getDevotionals(),
])

if (!devotional) {
  return Astro.redirect("/devocional")
}

const { title, content, explanation, verse, assets, date } = devotional

const assetUrl =
  typeof assets === "string"
    ? assets
    : Array.isArray(assets)
      ? assets[0]
      : undefined

function toYouTubeEmbedUrl(rawUrl: string): string | null {
  // Supports:
  // - https://youtu.be/:id
  // - https://www.youtube.com/watch?v=:id
  // - https://www.youtube.com/embed/:id
  const patterns = [
    /youtu\.be\/([^?&#/]+)/i,
    /youtube\.com\/watch\?v=([^?&#/]+)/i,
    /youtube\.com\/embed\/([^?&#/]+)/i,
  ]

  for (const regex of patterns) {
    const match = rawUrl.match(regex)
    if (match?.[1]) {
      return `https://www.youtube-nocookie.com/embed/${match[1]}?rel=0`
    }
  }

  return null
}

const youTubeEmbedUrl = assetUrl ? toYouTubeEmbedUrl(assetUrl) : null

// Append T00:00:00 to parse as local time, not UTC (Notion date is source of truth)
const formattedDate = new Date(date + "T00:00:00").toLocaleDateString("es-ES", {
  weekday: "long",
  year: "numeric",
  month: "long",
  day: "numeric",
})

function formatCardDate(dateStr: string): string {
  // Append T00:00:00 to parse as local time, not UTC (Notion date is source of truth)
  const d = new Date(dateStr + "T00:00:00")
  const parts = new Intl.DateTimeFormat("es-ES", {
    month: "long",
    day: "2-digit",
    year: "numeric",
  }).formatToParts(d)

  const day = parts.find((p) => p.type === "day")?.value ?? ""
  const month = parts.find((p) => p.type === "month")?.value ?? ""
  const year = parts.find((p) => p.type === "year")?.value ?? ""
  const capMonth = month ? month.charAt(0).toUpperCase() + month.slice(1) : ""

  return `${capMonth} ${day} de ${year}`.trim()
}

const recentDevotionals = (devotionals ?? [])
  .filter((item: Devotional) => item.id !== id)
  .slice(0, 4)

const steps: Step[] = [
  {
    title: "Prepárate para escuchar a Dios",
    description:
      "Invita en oración la presencia de Dios y pídele que su verdad te sea revelada antes de leer.",
    bullets: [
      "Respira profundo y aquieta tu mente.",
      "Pide que la lectura te muestre a Jesús y su voluntad.",
    ],
  },
  {
    title: "Lee y reflexiona en la Palabra",
    description:
      "Lee despacio y en voz alta si puedes, dejando que el Espíritu Santo subraye lo que necesitas hoy.",
    bullets: [
      "¿Qué te muestra este pasaje sobre quién es Dios?",
      "¿Qué te dice sobre tus actitudes o decisiones?",
      "¿Hay un ejemplo que seguir o evitar?",
    ],
  },
  {
    title: "Responde en oración",
    description: "Habla con Dios sobre lo que viste.",
    bullets: [
      "Pide perdón y recibe su gracia.",
      "Da gracias por sus promesas y cuidado.",
      "Presenta tus necesidades y las de otros.",
    ],
  },
  {
    title: "Aplica y registra",
    description: "Anota lo que Dios te habló y un paso concreto para hoy.",
    bullets: [
      "¿Qué le habló Dios?",
      "¿Qué cambiará en tu perspectiva?",
      "¿Cómo lo aplicarás en tu día a día?",
    ],
  },
]

const prompts: string[] = [
  "¿Quién es Dios aquí? ¿Qué hace o promete?",
  "¿Hay un pecado que confesar o una actitud que ajustar?",
  "¿Qué mandamiento debo obedecer hoy?",
  "¿Qué promesa puedo abrazar en este momento?",
  "¿Qué ejemplo me invita a seguir o evitar?",
]
---

<Layout title={title}>
  <section class="bg-primary text-white relative">
    <div class="container mx-auto px-4 py-6 md:py-8">
      <a
        href={"/devocional"}
        class="inline-flex items-center gap-1 text-white/80 hover:text-white transition-colors text-sm font-medium mt-22">
        <ArrowLeft size={18} />
        Volver
      </a>
    </div>
    <div
      class="min-h-[35vh] flex flex-col items-center justify-center text-center px-4">
      <p
        class="text-base uppercase tracking-[0.3em] text-white/80 font-semibold mb-3">
        Tiempo a solas con Dios
      </p>
      <h1
        class="text-4xl md:text-5xl font-bold leading-tight max-w-4xl"
        set:html={title}
      />
      <p class="mt-4 text-base md:text-lg text-white/80 capitalize">
        {formattedDate}
      </p>
    </div>
  </section>

  <main class="container mx-auto px-2 pb-16 space-y-12 md:space-y-16 mt-4 bg-white">
    <article
      class="max-w-4xl mx-auto bg-white border border-gray-200 rounded-3xl shadow-sm px-4 md:px-10 py-8 md:py-10 space-y-8">
      <!-- ADD VERSES EG: Mateo 2:19-21 -->
      {
        content && (
        <p class="text-[18px] text-gray-600 text-center -mt-6 font-bold" set:html={verse} />

          <div
            class="prose prose-lg max-w-none text-gray-800 leading-relaxed text-[20px]"
            set:html={content}
          />

        )
      }
      {
        assetUrl &&
          (youTubeEmbedUrl ? (
            <div class="w-full overflow-hidden rounded-2xl border border-gray-200 bg-black">
              <div class="relative w-full" style="padding-top: 56.25%;">
                <iframe
                  class="absolute inset-0 h-full w-full"
                  src={youTubeEmbedUrl}
                  title="Video devocional"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen
                  loading="lazy"
                  referrerpolicy="strict-origin-when-cross-origin"
                />
              </div>
            </div>
          ) : (
            <video
              src={assetUrl}
              class="w-full h-full object-cover rounded-2xl border border-gray-200"
              playsinline
              preload="metadata"
              controls
            />
          ))
      }
      {
        explanation && (
          <div class="rounded-2xl bg-gray-50 px-2 py-4">
            <p class="text-[20px] font-semibold text-gray-700 uppercase tracking-wide mb-2 text-center">
              Estimado lector
            </p>
            <div
              class="prose prose-lg max-w-none text-gray-800 leading-relaxed text-[20px]"
              set:html={explanation}
            />
          </div>
        )
      }

      <div class="rounded-2xl border border-accent/20 bg-primary/5 px-5 py-4">
        <div class="space-y-1">
          <p class="text-[18px] font-semibold text-accent text-center">
            Lleva la Palabra a tu día
          </p>
          <p class="text-base text-gray-800">
            Pregúntale al Señor cómo puedes vivir esto hoy: en tu trabajo, en tu
            familia, en tu forma de servir y amar.
          </p>
        </div>
      </div>
    </article>

    <section class="max-w-5xl mx-auto">
      <div class="flex items-center gap-3 mb-4">
        <div class="bg-accent/10 rounded-full p-2"> 
          <ClipboardList size={20} className="text-accent" />
        </div>

        <div>
          <p
            class="text-xs uppercase tracking-[0.2em] text-primary/90 font-semibold">
            Guía diaria
          </p>
          <h2 class="text-3xl font-bold text-gray-900 font-bebas">
            4 pasos para tu tiempo con Dios
          </h2>
        </div>
      </div>

      <div class="grid lg:grid-cols-[1.2fr_0.8fr] gap-8">
        <div class="space-y-3">
          {
            steps.map((step: Step, index: number) => (
              <details class="group border border-gray-200 rounded-2xl bg-white px-4 md:px-5 py-4 transition-shadow hover:shadow-sm">
                <summary class="flex items-center justify-between gap-4 cursor-pointer list-none">
                  <div class="flex items-center gap-3">
                    <div class="h-9 w-9 rounded-full bg-accent text-white flex items-center justify-center font-semibold">
                      {index + 1}
                    </div>
                    <div>
                      <p class="text-[12px] uppercase tracking-[0.2em] text-primary/80 font-semibold">
                        Paso {index + 1}
                      </p>
                      <h3 class="text-lg font-semibold text-gray-900 font-sans">
                        {step.title}
                      </h3>
                    </div>
                  </div>
                  <ChevronDown
                    size={18}
                    className="text-gray-500 transition-transform duration-200 group-open:rotate-180"
                  />
                </summary>
                <div class="mt-3 text-gray-700 leading-relaxed space-y-2">
                  <p>{step.description}</p>
                  {step.bullets && (
                    <ul class="list-disc list-inside space-y-1 text-gray-700">
                      {step.bullets.map((item: string) => (
                        <li>{item}</li>
                      ))}
                    </ul>
                  )}
                </div>
              </details>
            ))
          }
        </div>

        <!-- <div class="space-y-4">
          <div class="rounded-2xl border border-primary/20 bg-primary/5 px-5 py-4">
            <p class="text-sm font-semibold text-primary mb-1">
              Preguntas que ayudan
            </p>
            <p class="text-sm text-gray-700 mb-3">
              Usa estas preguntas mientras lees para ir más profundo.
            </p>
            <ul class="space-y-2 text-gray-800 text-sm">
              {
                prompts.map((prompt: string) => (
                  <li class="flex items-start gap-2">
                    <span class="mt-1 h-2 w-2 rounded-full bg-primary/90" />
                    <span>{prompt}</span>
                  </li>
                ))
              }
            </ul>
          </div>
          <div
            class="rounded-2xl border border-gray-200 bg-white px-5 py-4 flex gap-3">
            <div class="space-y-1">
              <p class="text-sm font-semibold text-gray-900">
                Registra lo que Dios te habló
              </p>
              <p class="text-sm text-gray-700">
                Guarda tus notas en un cuaderno o en tu app favorita. Eso hará
                que puedas volver a ellas y compartirlas con alguien más.
              </p>
            </div>
          </div>
        </div> -->
      </div>
    </section>

    {
      recentDevotionals.length > 0 && (
        <section class="max-w-5xl mx-auto">
          <div class="flex items-center gap-3 mb-6">
            <div class="bg-accent rounded-full p-2"> 
              <OpenBookIcon size={24} color="white" />
            </div>
            <h2 class="text-3xl font-bold text-gray-900 leading-tight font-bebas">
              Devocionales recientes
            </h2>
          </div>

          <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
            {recentDevotionals.map((item: Devotional) => (
              <a
                href={`/devocional/${item.id}`}
                class="group block rounded-2xl border border-gray-200 bg-gray-50 p-4 hover:bg-white hover:border-accent/60 hover:shadow-md transition-all">
                <div class="flex items-start gap-3">
                  <div>
                    <div class="flex items-center gap-2"> 
                      <Folder size={16} className="mt-0.5 text-gray-500 shrink-0" />
                    <h3
                      class="text-md font-semibold text-gray-900 leading-snug capitalize group-hover:text-accent transition-colors"
                    >
                      {item.title} | <span class="text-gray-500 text-base capitalize" set:html={item.verse} />
                    </h3>
                    </div>
                    <div class="mt-2 flex items-center gap-2 text-sm text-gray-600 capitalize">
                      <CalendarDays size={16} className="text-gray-500 shrink-0" />
                      <span>{formatCardDate(item.date)}</span>
                    </div>
                 
                  </div>
                </div>
              </a>
            ))}
          </div>
        </section>
      )
    }
  </main>
</Layout>
